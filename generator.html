<html>
  <head>
    <title>RDKS Generator</title>
    <script>
      function addToDataset(dataset, info) {
        dataset.value += info;
      }

      function generateHeader(dataset, docType, ecuName, ecuOffset) {
        if (docType == "vcp") {
          addToDataset(dataset, "<ZDC>\n");
          addToDataset(dataset, "<IDENT>\n");
          addToDataset(dataset, "<DATEIID></DATEIID>\n");
          addToDataset(dataset, "<VERSION-INHALT></VERSION-INHALT>\n");
          addToDataset(dataset, "<LOGIN>20103</LOGIN>\n");
          addToDataset(dataset, "<ALFID>24</ALFID>\n");
          addToDataset(dataset, "<PRNRREF></PRNRREF>\n");
          addToDataset(dataset, "</IDENT>\n");
          addToDataset(dataset, "<DATENBEREICHE>\n");
          addToDataset(dataset, "<DATENBEREICH>\n");
          addToDataset(dataset, "<DATEN-NAME>" + ecuName + ".xml</DATEN-NAME>\n");
          addToDataset(dataset, "<DATEN-FORMAT-NAME>DFN_HEX</DATEN-FORMAT-NAME>\n");
          addToDataset(dataset, "<START-ADR>" + ecuOffset + "</START-ADR>\n");
          addToDataset(dataset, "<GROESSE-DEKOMPRIMIERT>0x0800</GROESSE-DEKOMPRIMIERT>\n");
          addToDataset(dataset, "<DATEN>");
        } else if (docType == "odis") {
          addToDataset(dataset, "<MESSAGE DTD=\"XMLMSG\" VERSION=\"V0.1\">\n");
          addToDataset(dataset, "<RESULT>\n");
          addToDataset(dataset, "<RESPONSE NAME=\"GetParametrizeData\" DTD=\"RepairHints\" VERSION=\"1.4.0.0\" ID=\"0\">\n");
          addToDataset(dataset, "<DATA>\n");
          addToDataset(dataset, "<PARAMETER_DATA DIAGNOSTIC_ADDRESS=\"0x65\" START_ADDRESS=\"0x7E0800\" PR_IDX=\"0\" ZDC_NAME=\"v09600047P6\" ZDC_VERSION=\"0204\" LOGIN=\"20103\" LOGIN_IND=\"\">");
        } else {
          addToDataset(dataset, "\n\nERROR! Unknown docType\n\n");
        }
      }

      function generateFooter(dataset, docType) {
        if (docType == "vcp") {
          addToDataset(dataset, "</DATEN>\n");
          addToDataset(dataset, "</DATENBEREICH>\n");
          addToDataset(dataset, "</DATENBEREICHE>\n");
          addToDataset(dataset, "</ZDC>\n");
        } else if (docType == "odis") {
          addToDataset(dataset, "</PARAMETER_DATA>\n");
          addToDataset(dataset, "</DATA>\n");
          addToDataset(dataset, "</RESPONSE>\n");
          addToDataset(dataset, "</RESULT>\n");
          addToDataset(dataset, "</MESSAGE>\n");
        } else {
          addToDataset(dataset, "\n\nERROR! Unknown docType\n\n");
        }
	    }
    
      function appendType(byteStream, ecuType) {
        var type = parseInt(ecuType, 16);
        
        byteStream.push(type);
      }
    
      function appendSetName(byteStream, setName) {
        byteStream.push(setName.length);
        
        for (var index = 0; index < setName.length; index++)
          byteStream.push(setName.charCodeAt(index));
          
        for (var index = setName.length; index < 61; index++)
          byteStream.push(0x00);
      }

      function calcPressureValue(pressureStr) {
        if (pressureStr.length == 0)
          return 0xFF;

        return Math.round(parseFloat(pressureStr) * 10);
      }

      function appendSetPressure(byteStream, ecuName, pressureValues) {
        if (ecuName == "3AA907273H") {
          byteStream.push(calcPressureValue(pressureValues.frontPartial));
          byteStream.push(calcPressureValue(pressureValues.frontFull));
          byteStream.push(calcPressureValue(pressureValues.frontComfort));
          byteStream.push(calcPressureValue(pressureValues.rearPartial));
          byteStream.push(calcPressureValue(pressureValues.rearFull));
          byteStream.push(calcPressureValue(pressureValues.rearComfort));
        } else {
          byteStream.push(calcPressureValue(pressureValues.frontFull));
          byteStream.push(calcPressureValue(pressureValues.frontPartial));
          byteStream.push(calcPressureValue(pressureValues.frontComfort));
          byteStream.push(calcPressureValue(pressureValues.rearFull));
          byteStream.push(calcPressureValue(pressureValues.rearPartial));
          byteStream.push(calcPressureValue(pressureValues.rearComfort));
        }
      }

      function appendTireSet(byteStream, ecuName, tireSet) {
        for (var index = 0; index < 61; index++)
          byteStream.push(0x00);
        
        appendSetName(byteStream, tireSet.name);
        appendSetPressure(byteStream, ecuName, tireSet);
        
        for (var index = 0; index < 6; index++)
          byteStream.push(0x00);
      }

      function appendVersion(byteStream, ecuVersion) {
        var version1 = ecuVersion.charCodeAt(0);
        var version2 = ecuVersion.charCodeAt(1);
      
        byteStream.push(version1);
        byteStream.push(version2);
      }

      function appendCRC(byteStream) {
        var lookupTable = [];
        
        for (var index = 0; index < 256; index++) {
          var c = index;
          
          for (var k = 0; k < 8; k++)
            c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1);

          lookupTable[index] = c;
        }

        var crc = 0xFFFFFFFF;
        
        for (var index = 0; index < byteStream.length; index++ )
          crc = (crc >>> 8) ^ lookupTable[(crc ^ byteStream[index]) & 0xFF];
          
        crc = crc ^ 0xFFFFFFFF;
        
        byteStream.push((crc >>> 24) & 0xFF);
        byteStream.push((crc >>> 16) & 0xFF);
        byteStream.push((crc >>> 8) & 0xFF);
        byteStream.push(crc & 0xFF);
      }

      function generateBody(dataset, ecuName, ecuType, ecuVersion, tireSets) {
        var byteStream = [];

        appendType(byteStream, ecuType);
        byteStream.push(0x00);

        var setEmpty = {name:"", frontFull:"", rearFull:"", frontPartial:"", rearPartial:"", frontComfort:"", rearComfort:""};

        for (var index = 0; index < 11; index++) {
          if (index < tireSets.length)
            appendTireSet(byteStream, ecuName, tireSets[index]);
          else
            appendTireSet(byteStream, ecuName, setEmpty);
        }

        for (var index = 0; index < 555; index++)
          byteStream.push(0xFF);
        
        appendVersion(byteStream, ecuVersion);
        appendCRC(byteStream);

        for (var index = 0; index < byteStream.length; index++ ) {
          var str = byteStream[index].toString(16).toUpperCase();
          
          if (str.length < 2)
            str = '0' + str;

          if (index > 0)
            addToDataset(dataset, ",0x" + str);
          else
            addToDataset(dataset, "0x" + str);
        }
      }
    
      function doGenerate() {
        var dataset = document.getElementById('dataset');
        dataset.value = "";
    
        var docType = document.getElementById('docType').value;
        var ecuObj = document.getElementById('dataOffset');
        var ecuOptions = ecuObj.options[ecuObj.selectedIndex];
        var ecuName = ecuOptions.text;
        var ecuOffset = ecuOptions.getAttribute('ecuOffset');
        var ecuVersion = ecuOptions.getAttribute('ecuVersion');
        var ecuType = ecuOptions.getAttribute('ecuType');
        
        var tireSets = [];

        for (var index = 1; index <= 11; index++) {
          var set = {
            name:document.getElementById("t" + index + "name").value,
            frontFull:document.getElementById("t" + index + "pff").value,
            rearFull:document.getElementById("t" + index + "prf").value,
            frontPartial:document.getElementById("t" + index + "pfp").value,
            rearPartial:document.getElementById("t" + index + "prp").value,
            frontComfort:document.getElementById("t" + index + "pfc").value,
            rearComfort:document.getElementById("t" + index + "prc").value
          };

          tireSets.push(set);
        }
        
		    generateHeader(dataset, docType, ecuName, ecuOffset);
        generateBody(dataset, ecuName, ecuType, ecuVersion, tireSets);
        generateFooter(dataset, docType);
      }
	  </script>
  </head>
  <body>
    <form>
      <label>RDKS ECU:
  	    <select id="dataOffset" size="1">
          <option ecuOffset="0x7FC000" ecuVersion="2B" ecuType="74">3AA907273D(forum)</option>
		      <option ecuOffset="0x7E0800" ecuVersion="25" ecuType="22">5Q0907273B</option>
	      </select>
	    </label>
	    <br> <br>
	    <label>Tire set #1 name:
	      <input id="t1name" value="205/55R16">
	    </label>
      <br>
      <label>Tire set #1 Pressure front (fully loaded):
        <input id="t1pff" value="2.7">
      </label>
      <br>
      <label>Tire set #1 Pressure rear (fully loaded):
        <input id="t1prf" value="3.0">
      </label>
      <br>
      <label>Tire set #1 Pressure front (partially loaded):
        <input id="t1pfp" value="2.3">
      </label>
      <br>
      <label>Tire set #1 Pressure rear (partially loaded):
        <input id="t1prp" value="2.3">
      </label>
      <br>
      <label>Tire set #1 Pressure front (comfort):
        <input id="t1pfc">
      </label>
      <br>
      <label>Tire set #1 Pressure rear (comfort):
        <input id="t1prc">
      </label>
      <br> <br>
      <label>Tire set #2 name:
        <input id="t2name" value="225/40R18">
      </label>
      <br>
      <label>Tire set #2 Pressure front (fully loaded):
        <input id="t2pff" value="3.0">
      </label>
      <br>
      <label>Tire set #2 Pressure rear (fully loaded):
        <input id="t2prf" value="3.2">
      </label>
      <br>
      <label>Tire set #2 Pressure front (partially loaded):
        <input id="t2pfp" value="2.7">
      </label>
      <br>
      <label>Tire set #2 Pressure rear (partially loaded):
        <input id="t2prp" value="2.7">
      </label>
      <br>
      <label>Tire set #2 Pressure front (comfort):
        <input id="t2pfc">
      </label>
      <br>
      <label>Tire set #2 Pressure rear (comfort):
        <input id="t2prc">
      </label>
      <br> <br>
      <script>
        for (var index = 3; index <= 10; index++) {
          document.write("          <label>Tire set #" + index + " name:");
          document.write("          <input id=\"t" + index + "name\">");
          document.write("          </label>");
          document.write("          <br>");
          document.write("          <label>Tire set #" + index + " Pressure front (fully loaded):");
          document.write("          <input id=\"t" + index + "pff\">");
          document.write("          </label>");
          document.write("          <br>");
          document.write("          <label>Tire set #" + index + " Pressure rear (fully loaded):");
          document.write("          <input id=\"t" + index + "prf\">");
          document.write("          </label>");
          document.write("          <br>");
          document.write("          <label>Tire set #" + index + " Pressure front (partially loaded):");
          document.write("          <input id=\"t" + index + "pfp\">");
          document.write("          </label>");
          document.write("          <br>");
          document.write("          <label>Tire set #" + index + " Pressure rear (partially loaded):");
          document.write("          <input id=\"t" + index + "prp\">");
          document.write("          </label>");
          document.write("          <br>");
          document.write("          <label>Tire set #" + index + " Pressure front (comfort):");
          document.write("          <input id=\"t" + index + "pfc\">");
          document.write("          </label>");
          document.write("          <br>");
          document.write("          <label>Tire set #" + index + " Pressure rear (comfort):");
          document.write("          <input id=\"t" + index + "prc\">");
          document.write("          </label>");
          document.write("          <br> <br>");
        }
      </script>
      <label>Tire set Individual name:
        <input id="t11name" value="Individ.">
      </label>
      <br>
      <label>Tire set Individual Pressure front (fully loaded):
        <input id="t11pff" value="2.5">
      </label>
      <br>
      <label>Tire set Individual Pressure rear (fully loaded):
        <input id="t11prf" value="2.5">
      </label>
      <br>
      <label>Tire set Individual Pressure front (partially loaded):
        <input id="t11pfp" value="2.5">
      </label>
      <br>
      <label>Tire set Individual Pressure rear (partially loaded):
        <input id="t11prp" value="2.5">
      </label>
      <br>
      <label>Tire set Individual Pressure front (comfort):
        <input id="t11pfc">
      </label>
      <br>
      <label>Tire set Individual Pressure rear (comfort):
        <input id="t11prc">
      </label>
      <br> <br>
      <label>Dataset type:
        <select id="docType" size="1">
          <option value="vcp">VCP</option>
          <option value="odis">ODIS</option>
        </select>
      </label>
	    <br> <br>
	    <button type="button" id="generate" onclick="doGenerate();">Generate dataset</button>
	    <br> <br>
	    <textarea id="dataset" cols="50" rows="10"></textarea>
	  </form>
  </body>
</html>
